#!/usr/bin/env python
# -*- coding: utf-8 -*-
# 
# segments_cf_format_output.py
#
print('-----------------  --------------------------')

import time
from pathlib import Path
import pandas as pd
import numpy as np
import geopandas as gpd
from geopandas.tools import sjoin
import osmnx as ox

cwd = Path.cwd()
pathin = cwd.parent / 'processed'
pathproc = cwd.parent / 'processed'
pathout = cwd.parent / 'processed'

print("Local current time :", time.asctime( time.localtime(time.time()) ))
#_________________________________
#
#input 
infile = 'segments_cf_poly_metrics.geojson'
metrics_gdf = gpd.read_file(pathproc / infile, encoding='utf-8')
print(metrics_gdf)
metrics_gdf.info()

del metrics_gdf['quarter']
metrics_gdf.rename(columns={'_t_street_e': '_shemangli', '_t_street': '_t_rechov', }, inplace=True)

metrics_gdf['ids'] = metrics_gdf['_shemangli'] + '_' + metrics_gdf['id'].astype(str)
print(metrics_gdf)
metrics_gdf.info()


metric_col_list = ['sum_hours_x_meters_buff100', 
                    'sum_weekly_delivery_freq_buff100', 
                    'sum_hours_x_meters_snap100', 
                    'sum_weekly_delivery_freq_snap100', 
                    'min_per_delivery_buff100', 
                    'min_per_delivery_snap100']
#print(metric_col_list)

mean_list = []
std_list = []
mean_std_list=[]
for metric_col in metric_col_list :
    mean_std_list.append(list([metrics_gdf[metric_col].mean(), metrics_gdf[metric_col].std()]))

mean_std_df = pd.DataFrame({'metric': metric_col_list, 'mean_std': mean_std_list})
mean_std_df = mean_std_df.set_index('metric')
print(mean_std_df)

#output average_stdev.js
json_fileout = pathout / ('average_stdev.js')
print(json_fileout)
#mean_std_df.to_json(json_fileout)
json_str = mean_std_df.to_json()
json_str = json_str.replace('{"mean_std":{', 'var averageStdev = {\n').replace(']}}', ']\n};').replace('],"', '],\n"')
print(json_str)
nf = open(json_fileout, "w", encoding="utf8")
nf.write(json_str)
nf.close()
print(("Saved file: ", json_fileout))

# reformat metrics as norm 
for metric_col in metric_col_list :
    #print(metric_col)
    metrics_gdf['mean_'+ metric_col] = metrics_gdf[metric_col].mean()
    metrics_gdf['std_'+ metric_col] = metrics_gdf[metric_col].std()
    metrics_gdf['norm_'+ metric_col] = (metrics_gdf[metric_col] - metrics_gdf['mean_'+ metric_col]) / metrics_gdf['std_'+ metric_col]
    del metrics_gdf['mean_'+ metric_col]
    del metrics_gdf['std_'+ metric_col]
    del metrics_gdf[metric_col]

print(metrics_gdf)
metrics_gdf.info()

#project from 2039 to crs 4326 for leaflet
metrics_gdf = ox.project_gdf(metrics_gdf, to_crs='epsg:4326')
print(metrics_gdf['geometry'])
metrics_gdf.info()

#output segments_cf_poly_metrics_norm_4326.geojson
geojson_fileout = pathout / ('segments_cf_poly_metrics_norm_4326.geojson')
print(geojson_fileout)
metrics_gdf.to_file(geojson_fileout, driver="GeoJSON")

# reformat as js and output
txtfilein = geojson_fileout
textfileout = pathout / ('street_segments25.js')
fw = open(textfileout, 'w', encoding="utf8")
with open(txtfilein, encoding="utf8") as f:
    header = f.readline()
    fw.write('var ss_polys = ' + header)
    #print(header)
    for row in f.readlines():
        #print (row)
        fw.write(row)
fw.close()
print(textfileout)



"""
#input supply file
infile = 'Trafic Signs Points prika ve teina v5s_ap.geojson'
supply_gdf = gpd.read_file(pathin / infile, encoding='utf-8')
del supply_gdf['statusdate']
del supply_gdf['lastupdate']
#print(supply_gdf)

#input supply snapped file
infile = 'Trafic Signs Points prika ve teina v5s_ap snap100 cf.geojson'
supply_snap_gdf = gpd.read_file(pathproc / infile, encoding='utf-8')
#del supply_snap_gdf['statusdate']
#del supply_snap_gdf['lastupdate']
#print(supply_snap_gdf)

#input demand file
infile = 'tlv_businesses_w_logistics_filtered.csv'
demand_gdf = gpd.read_file(pathin / infile, encoding='utf-8')
demand_gdf.set_crs(epsg=2039, inplace=True)
demand_gdf.rename(columns={'תדירות הפצות שבועית': 'weekly_delivery_freq'}, inplace=True)
demand_gdf['weekly_delivery_freq'] = demand_gdf['weekly_delivery_freq'].astype(float)
#print(demand_gdf.x_coord, demand_gdf.y_coord)
demand_gdf.geometry = gpd.points_from_xy(demand_gdf.x_coord, demand_gdf.y_coord)
#print(demand_gdf)
#demand_gdf.info()

#input demand snaped file
infile = 'tlv_businesses_w_logistics_filtered_snap100_cf.geojson'
demand_snap_gdf = gpd.read_file(pathproc / infile, encoding='utf-8')
demand_snap_gdf.rename(columns={'תדירות הפצות שבועית': 'weekly_delivery_freq'}, inplace=True)
demand_snap_gdf['weekly_delivery_freq'] = demand_snap_gdf['weekly_delivery_freq'].astype(float)

#=============================================

# sum supply and demand points in cf segments buff 100

polygons_contains = sjoin(cf_buff100_gdf[['id','geometry']], supply_gdf[['_hours_x_meters','geometry']], predicate='contains', how='left')
polygons_contains = polygons_contains.dropna()
#print (polygons_contains)
#polygons_contains.info()
#supply_in_cf_buff100_gdf = polygons_contains.groupby(['id'])['_hours_x_meters'].aggregate(['max','sum', 'count'])
supply_in_cf_buff100_gdf = polygons_contains.groupby(['id'])['_hours_x_meters'].aggregate(['sum'])
supply_in_cf_buff100_gdf.rename(columns={'sum': 'sum_hours_x_meters_buff100'}, inplace=True)
#print (supply_in_cf_buff100_gdf)
supply_in_cf_buff100_gdf = pd.merge(supply_in_cf_buff100_gdf, cf_buff100_gdf[['id','geometry']], on='id')
print (supply_in_cf_buff100_gdf)

polygons_contains = sjoin(cf_buff100_gdf[['id','geometry']], demand_gdf[['weekly_delivery_freq','geometry']], predicate='contains', how='left')
polygons_contains = polygons_contains.dropna()
#print (polygons_contains)
#polygons_contains.info()
#demand_in_cf_buff100_gdf = polygons_contains.groupby(['id'])['weekly_delivery_freq'].aggregate(['max','sum', 'count'])
demand_in_cf_buff100_gdf = polygons_contains.groupby(['id'])['weekly_delivery_freq'].aggregate(['sum'])
demand_in_cf_buff100_gdf.rename(columns={'sum': 'sum_weekly_delivery_freq_buff100'}, inplace=True)
#print (demand_in_cf_buff100_gdf)
demand_in_cf_buff100_gdf = pd.merge(demand_in_cf_buff100_gdf, cf_buff100_gdf[['id','geometry']], on='id')
print (demand_in_cf_buff100_gdf)

# sum snapped supply and snapped demand points in cf segments buff 5

polygons_contains = sjoin(cf_buff5_gdf[['id','geometry']], supply_snap_gdf[['_hours_x_meters','geometry']], predicate='contains', how='left')
polygons_contains = polygons_contains.dropna()
#print (polygons_contains)
#polygons_contains.info()
#supply_in_cf_buff5_gdf = polygons_contains.groupby(['id'])['_hours_x_meters'].aggregate(['max','sum', 'count'])
supply_in_cf_buff5_gdf = polygons_contains.groupby(['id'])['_hours_x_meters'].aggregate(['sum'])
supply_in_cf_buff5_gdf.rename(columns={'sum': 'sum_hours_x_meters_snap100'}, inplace=True)
#print (supply_in_cf_buff5_gdf)
supply_in_cf_buff5_gdf = pd.merge(supply_in_cf_buff5_gdf, cf_buff5_gdf[['id','geometry']], on='id')
print (supply_in_cf_buff5_gdf)

polygons_contains = sjoin(cf_buff5_gdf[['id','geometry']], demand_snap_gdf[['weekly_delivery_freq','geometry']], predicate='contains', how='left')
polygons_contains = polygons_contains.dropna()
#print (polygons_contains)
#polygons_contains.info()
#demand_in_cf_buff5_gdf = polygons_contains.groupby(['id'])['weekly_delivery_freq'].aggregate(['max','sum', 'count'])
demand_in_cf_buff5_gdf = polygons_contains.groupby(['id'])['weekly_delivery_freq'].aggregate(['sum'])
demand_in_cf_buff5_gdf.rename(columns={'sum': 'sum_weekly_delivery_freq_snap100'}, inplace=True)
#print (demand_in_cf_buff5_gdf)
demand_in_cf_buff5_gdf = pd.merge(demand_in_cf_buff5_gdf, cf_buff5_gdf[['id','geometry']], on='id')
print (demand_in_cf_buff5_gdf)
#demand_in_cf_buff5_gdf.info()

#output 
geojson_fileout = pathout / ('cf_buff5_gdf.geojson')
print(geojson_fileout)
cf_buff5_gdf.to_file(geojson_fileout, driver="GeoJSON")

#output 
geojson_fileout = pathout / ('supply_snap_gdf.geojson')
print(geojson_fileout)
supply_snap_gdf[['_hours_x_meters','geometry']].to_file(geojson_fileout, driver="GeoJSON")

#output 
geojson_fileout = pathout / ('demand_snap_gdf.geojson')
print(geojson_fileout)
demand_snap_gdf[['weekly_delivery_freq','geometry']].to_file(geojson_fileout, driver="GeoJSON")


# collect sum point in poly metrics

segments_cf_poly_metrics_gdf = cf_buff25_gdf.copy()

segments_cf_poly_metrics_gdf = pd.merge(segments_cf_poly_metrics_gdf, supply_in_cf_buff100_gdf[['id','sum_hours_x_meters_buff100']], on='id', how='left')
segments_cf_poly_metrics_gdf['sum_hours_x_meters_buff100'] = segments_cf_poly_metrics_gdf['sum_hours_x_meters_buff100'].fillna(0.0)
print(segments_cf_poly_metrics_gdf)
segments_cf_poly_metrics_gdf.info()

segments_cf_poly_metrics_gdf = pd.merge(segments_cf_poly_metrics_gdf, demand_in_cf_buff100_gdf[['id','sum_weekly_delivery_freq_buff100']], on='id', how='left')
segments_cf_poly_metrics_gdf['sum_weekly_delivery_freq_buff100'] = segments_cf_poly_metrics_gdf['sum_weekly_delivery_freq_buff100'].fillna(0.0)
print(segments_cf_poly_metrics_gdf)
segments_cf_poly_metrics_gdf.info()

segments_cf_poly_metrics_gdf = pd.merge(segments_cf_poly_metrics_gdf, supply_in_cf_buff5_gdf[['id','sum_hours_x_meters_snap100']], on='id', how='left')
segments_cf_poly_metrics_gdf['sum_hours_x_meters_snap100'] = segments_cf_poly_metrics_gdf['sum_hours_x_meters_snap100'].fillna(0.0)
print(segments_cf_poly_metrics_gdf)
segments_cf_poly_metrics_gdf.info()

segments_cf_poly_metrics_gdf = pd.merge(segments_cf_poly_metrics_gdf, demand_in_cf_buff5_gdf[['id','sum_weekly_delivery_freq_snap100']], on='id', how='left')
segments_cf_poly_metrics_gdf['sum_weekly_delivery_freq_snap100'] = segments_cf_poly_metrics_gdf['sum_weekly_delivery_freq_snap100'].fillna(0.0)
print(segments_cf_poly_metrics_gdf)
segments_cf_poly_metrics_gdf.info()

# collect derived metrics
segments_cf_poly_metrics_gdf['min_per_delivery_buff100'] = (60.0*segments_cf_poly_metrics_gdf['sum_hours_x_meters_buff100']/6.0)/segments_cf_poly_metrics_gdf['sum_weekly_delivery_freq_buff100'] 
segments_cf_poly_metrics_gdf['min_per_delivery_buff100'] = segments_cf_poly_metrics_gdf['min_per_delivery_buff100'].fillna(0.0)
segments_cf_poly_metrics_gdf['min_per_delivery_snap100'] = (60.0*segments_cf_poly_metrics_gdf['sum_hours_x_meters_snap100']/6.0)/segments_cf_poly_metrics_gdf['sum_weekly_delivery_freq_snap100'] 
segments_cf_poly_metrics_gdf['min_per_delivery_snap100'] = segments_cf_poly_metrics_gdf['min_per_delivery_snap100'].fillna(0.0)
print(segments_cf_poly_metrics_gdf)
segments_cf_poly_metrics_gdf.info()

#output 
geojson_fileout = pathout / ('segments_cf_poly_metrics.geojson')
print(geojson_fileout)
segments_cf_poly_metrics_gdf.to_file(geojson_fileout, driver="GeoJSON")
"""

print("Local current time :", time.asctime( time.localtime(time.time()) ))
